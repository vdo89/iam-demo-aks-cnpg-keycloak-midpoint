apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: rws-keycloak
  namespace: iam
  annotations:
    argocd.argoproj.io/sync-wave: "30"
spec:
  image: quay.io/keycloak/keycloak:26.3.5
  instances: 1
  startOptimized: false
  additionalOptions:
    - name: health-enabled
      value: "true"
    - name: metrics-enabled
      value: "true"
    - name: http-management-enabled
      value: "true"
    - name: http-management-host
      value: "0.0.0.0"
    - name: cache
      value: local
    - name: proxy
      value: edge
  features:
    enabled:
      - token-exchange
  hostname:
    hostname: kc.132.164.56.132.nip.io
    strict: false
    strictBackchannel: false
  proxy:
    headers: xforwarded
  http:
    httpEnabled: true

  db:
    vendor: postgres
    url: "jdbc:postgresql://iam-db-rw.iam.svc.cluster.local:5432/keycloak?sslmode=require"
    schema: public
    usernameSecret: { name: keycloak-db-app, key: username }
    passwordSecret: { name: keycloak-db-app, key: password }

  ingress:
    enabled: true
    ingressClassName: nginx
    path: /
    pathType: Prefix
    annotations:
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
      nginx.ingress.kubernetes.io/ssl-redirect: "false"
